<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>國衛院 AI語音地圖資源與長照地圖 V4.20</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <!-- FontAwesome CDN -->
    <script src="https://kit.fontawesome.com/a2e8c8c4e1.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto py-10 px-4">
        <h1 class="text-2xl font-bold mb-5">長照關懷服務地圖查詢</h1>
        <div class="flex space-x-4 mb-5">
            <button id="generalSearchTab" class="px-4 py-2 bg-blue-500 text-white rounded-lg active">一般搜尋</button>
            <button id="ltcSearchTab" class="px-4 py-2 bg-gray-300 text-black rounded-lg">長照資源搜尋</button>
        </div>
        <div id="searchBox" class="mb-5">
            <input id="searchInput" type="text" class="w-full p-2 border rounded" placeholder="搜尋附近地點...">
            <div class="mt-2">
                <label for="searchRadius" class="mr-2">搜尋範圍：</label>
                <select id="searchRadius" class="p-1 border rounded">
                    <option value="1000">1 公里</option>
                    <option value="2000">2 公里</option>
                    <option value="5000">5 公里</option>
                </select>
            </div>
        </div>
        <div id="loadingIndicator" class="hidden mb-5">
            <p class="text-center">搜尋中，請稍候...</p>
        </div>
        <div id="resultsContainer"></div>
    </div>

    <script>
        let userLatitude, userLongitude;
        let defaultSearchType = localStorage.getItem('defaultSearchType') || 'general';
        const generalSearchTab = document.getElementById('generalSearchTab');
        const ltcSearchTab = document.getElementById('ltcSearchTab');
        const searchInput = document.getElementById('searchInput');
        const searchRadius = document.getElementById('searchRadius');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContainer = document.getElementById('resultsContainer');
        let currentSearchType = defaultSearchType;

        // Set up initial tab
        if (defaultSearchType === 'ltc') {
            generalSearchTab.classList.remove('active');
            generalSearchTab.classList.add('bg-gray-300', 'text-black');
            ltcSearchTab.classList.remove('bg-gray-300', 'text-black');
            ltcSearchTab.classList.add('bg-blue-500', 'text-white');
            searchInput.placeholder = '搜尋附近長照資源...';
        } else {
            // default is general
            generalSearchTab.classList.add('active');
        }

        // Get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                userLatitude = position.coords.latitude;
                userLongitude = position.coords.longitude;
            }, (error) => {
                alert('無法取得您的位置。請確保已允許位置存取。');
            });
        } else {
            alert('您的瀏覽器不支援地理定位功能。');
        }

        // Switch between General and LTC search
        generalSearchTab.addEventListener('click', () => {
            if (currentSearchType !== 'general') {
                generalSearchTab.classList.add('bg-blue-500', 'text-white');
                generalSearchTab.classList.remove('bg-gray-300', 'text-black');
                ltcSearchTab.classList.add('bg-gray-300', 'text-black');
                ltcSearchTab.classList.remove('bg-blue-500', 'text-white');
                searchInput.placeholder = '搜尋附近地點...';
                currentSearchType = 'general';
                localStorage.setItem('defaultSearchType', 'general');
            }
        });

        ltcSearchTab.addEventListener('click', () => {
            if (currentSearchType !== 'ltc') {
                ltcSearchTab.classList.add('bg-blue-500', 'text-white');
                ltcSearchTab.classList.remove('bg-gray-300', 'text-black');
                generalSearchTab.classList.add('bg-gray-300', 'text-black');
                generalSearchTab.classList.remove('bg-blue-500', 'text-white');
                searchInput.placeholder = '搜尋附近長照資源...';
                currentSearchType = 'ltc';
                localStorage.setItem('defaultSearchType', 'ltc');
            }
        });

        // Perform search
        function performSearch(query) {
            if (!query.trim()) return;

            // Show loading indicator
            loadingIndicator.classList.remove('hidden');
            resultsContainer.innerHTML = '';

            // Add to search history
            addToHistory(query);

            // Create a URL for Google Maps search
            const radius = searchRadius.value || 1000;

            if (currentSearchType === 'general') {
                // Regular search for general locations
                const googleMapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(query)}/@${userLatitude},${userLongitude},15z`;
                const directionsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLatitude},${userLongitude}&destination=${encodeURIComponent(query)}&travelmode=driving`;

                setTimeout(() => {
                    loadingIndicator.classList.add('hidden');

                    // Create main result card with iframe
                    const mainResultCard = document.createElement('div');
                    mainResultCard.className = 'bg-white rounded-lg shadow-md overflow-hidden mb-5';
                    mainResultCard.innerHTML = `
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2">${query} 附近搜尋結果</h3>
                            <p class="text-sm text-gray-600 mb-3">搜尋範圍: ${radius / 1000} 公里</p>
                        </div>
                        <div class="p-4 flex justify-end">
                            <button id="toggleMapBtn" class="bg-blue-500 text-white py-2 px-4 rounded-lg" onclick="const m = document.getElementById('previewMap'); m.classList.toggle('hidden'); this.innerText = m.classList.contains('hidden') ? '顯示預覽地圖' : '隱藏預覽地圖';">顯示預覽地圖</button>
                        </div>
                        <div id="previewMap" class="h-60 w-full bg-gray-100 hidden">
                            <iframe 
                                src="https://www.openstreetmap.org/export/embed.html?bbox=${userLongitude - 0.01},${userLatitude - 0.01},${userLongitude + 0.01},${userLatitude + 0.01}&layer=mapnik&marker=${userLatitude},${userLongitude}" 
                                class="w-full h-full border-0">
                            </iframe>
                        </div>
                        <div class="p-4 flex justify-between">
                            <a href="${googleMapsUrl}" target="_blank" class="bg-blue-500 text-white py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-search mr-2"></i> 請點我查看搜尋結果
                            </a>
                            <a href="${directionsUrl}" target="_blank" class="bg-green-500 text-white py-2 px-4 rounded-lg flex items-center">
                                <i class="fas fa-directions mr-2"></i> 直接導航到最近位置
                            </a>
                        </div>
                    `;
                    resultsContainer.appendChild(mainResultCard);

                    // Add a message explaining how to get real results
                    const messageCard = document.createElement('div');
                    messageCard.className = 'bg-blue-50 p-4 rounded-lg text-blue-800 text-sm';
                    messageCard.innerHTML = `
                        <p class="mb-2"><i class="fas fa-info-circle mr-1"></i> 點擊上方按鈕，可在 Google Maps 中查看完整結果和導航。</p>
                        <p>由於不使用付費 API，本頁面提供跳轉功能讓您使用 Google Maps 的完整功能。</p>
                    `;
                    resultsContainer.appendChild(messageCard);

                    // Create a few example POI items that might be relevant to the search
                    createExamplePOIs(query);
                }, 1500);
            } else {
                // LTC-specific search
                const ltcSearchUrl = `https://www.google.com/maps/search/${encodeURIComponent(query + ' 長照機構')}/@${userLatitude},${userLongitude},15z`;
                const mohwUrl = `https://ltcpap.mohw.gov.tw/public/index.html`;

                setTimeout(() => {
                    loadingIndicator.classList.add('hidden');

                    // Create main result card
                    const mainResultCard = document.createElement('div');
                    mainResultCard.className = 'bg-white rounded-lg shadow-md overflow-hidden mb-5';
                    mainResultCard.innerHTML = `
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2">${query} 長照資源搜尋結果</h3>
                            <p class="text-sm text-gray-600 mb-3">搜尋範圍: ${radius / 1000} 公里</p>
                        </div>
                        <div class="p-4 flex justify-between">
                            <a href="${ltcSearchUrl}" target="_blank" class="bg-blue-500 text-white py-2 px-4 rounded-lg flex items-center flex-1 justify-center mr-2">
                                <i class="fas fa-search mr-2"></i> Google 搜尋
                            </a>
                            <a href="${mohwUrl}" target="_blank" class="bg-green-500 text-white py-2 px-4 rounded-lg flex items-center flex-1 justify-center">
                                <i class="fas fa-heartbeat mr-2"></i> 衛福部長照地圖
                            </a>
                        </div>
                        <div class="p-4 flex justify-end">
                            <button id="toggleMapBtn" class="bg-blue-500 text-white py-2 px-4 rounded-lg" onclick="const m = document.getElementById('previewMap'); m.classList.toggle('hidden'); this.innerText = m.classList.contains('hidden') ? '顯示預覽地圖' : '隱藏預覽地圖';">顯示預覽地圖</button>
                        </div>
                        <div id="previewMap" class="h-60 w-full bg-gray-100 hidden">
                            <iframe 
                                src="https://www.openstreetmap.org/export/embed.html?bbox=${userLongitude - 0.01},${userLatitude - 0.01},${userLongitude + 0.01},${userLatitude + 0.01}&layer=mapnik&marker=${userLatitude},${userLongitude}" 
                                class="w-full h-full border-0">
                            </iframe>
                        </div>
                    `;
                    resultsContainer.appendChild(mainResultCard);

                    // Add a message explaining how to get real results
                    const messageCard = document.createElement('div');
                    messageCard.className = 'bg-blue-50 p-4 rounded-lg text-blue-800 text-sm';
                    messageCard.innerHTML = `
                        <p class="mb-2"><i class="fas fa-info-circle mr-1"></i> 點擊「衛福部長照地圖」，使用官方資源查詢更精準的長照資訊。</p>
                        <p>衛福部提供的長照地圖包含完整、權威的長照資源資訊，是尋找長照服務的最佳工具。</p>
                    `;
                    resultsContainer.appendChild(messageCard);
                }, 1500);
            }
        }

        // Add event listener to search input
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch(searchInput.value);
            }
        });

        // Search history
        function addToHistory(query) {
            let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            history.unshift(query);
            history = [...new Set(history)]; // remove duplicates
            if (history.length > 5) history.pop(); // keep last 5
            localStorage.setItem('searchHistory', JSON.stringify(history));
            displayHistory();
        }

        function displayHistory() {
            // Not implemented: Could display history if needed
        }

        // Create example POIs for general category
        function createExamplePOIs(query) {
            const categories = {
                '餐廳': ['餐廳', '美食', '小吃', '飯館', '食'],
                '咖啡': ['咖啡', '下午茶', '蛋糕'],
                '景點': ['景點', '觀光', '公園', '名勝', '古蹟'],
                '購物': ['商場', '超市', '百貨', '市場', '購物', '賣場'],
                '住宿': ['飯店', '旅館', '民宿', '住宿'],
                '交通': ['捷運', '車站', '公車', '停車場', '加油站'],
                '醫療': ['醫院', '診所', '藥局', '醫療'],
                '教育': ['學校', '大學', '補習班', '圖書館']
            };

            let categoryMatch = '其他';
            for (const [category, keywords] of Object.entries(categories)) {
                if (keywords.some(keyword => query.includes(keyword))) {
                    categoryMatch = category;
                    break;
                }
            }

            // Generate random example POIs based on the category
            const examplePOIs = generateExamplePOIs(categoryMatch, 3);

            const poiTitle = document.createElement('h3');
            poiTitle.className = 'font-semibold text-gray-800 mt-5 mb-3';
            poiTitle.textContent = `推薦的${categoryMatch}地點`;
            resultsContainer.appendChild(poiTitle);

            examplePOIs.forEach(poi => {
                const poiCard = document.createElement('div');
                poiCard.className = 'bg-white rounded-lg shadow-sm p-4 flex items-start';

                const rating = (Math.random() * 2 + 3).toFixed(1);
                const distance = (Math.random() * 0.9 + 0.1).toFixed(1);

                poiCard.innerHTML = `
                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="${poi.icon} text-lg text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${poi.name}</h4>
                        <div class="flex items-center text-sm mt-1">
                            <div class="text-yellow-500 mr-1">★</div>
                            <span class="text-gray-700">${rating}</span>
                            <span class="mx-2 text-gray-300">|</span>
                            <span class="text-gray-600">${distance} 公里</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${poi.address}</p>
                    </div>
                    <a href="https://www.google.com/maps/dir/?api=1&origin=${userLatitude},${userLongitude}&destination=${encodeURIComponent(poi.name + ' ' + poi.address)}&travelmode=driving" target="_blank" class="ml-2 w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 flex-shrink-0">
                        <i class="fas fa-directions"></i>
                    </a>
                `;

                resultsContainer.appendChild(poiCard);
            });
        }

        // Generate example POIs based on category
        function generateExamplePOIs(category, count) {
            const poiData = {
                '餐廳': {
                    names: ['鮮味中華料理', '好吃家常菜館', '饗味日式料理', '經典美式餐廳', '義饗義大利麵坊'],
                    icon: 'fas fa-utensils'
                },
                '咖啡': {
                    names: ['咖啡時光', '星巴克咖啡', '伯朗咖啡館', '路易莎咖啡', '半山咖啡廳'],
                    icon: 'fas fa-coffee'
                },
                '景點': {
                    names: ['中正紀念堂', '國立博物館', '市立公園', '古蹟文化園區', '觀景步道'],
                    icon: 'fas fa-landmark'
                },
                '購物': {
                    names: ['環球購物中心', '時代百貨', '好市多賣場', '國際名品商場', '樂購超市'],
                    icon: 'fas fa-shopping-bag'
                },
                '住宿': {
                    names: ['麗晶大飯店', '舒適旅館', '溫馨民宿', '國際連鎖酒店', '商務旅店'],
                    icon: 'fas fa-bed'
                },
                '交通': {
                    names: ['中央車站', '捷運站', '國際機場', '公車總站', '轉運站'],
                    icon: 'fas fa-subway'
                },
                '醫療': {
                    names: ['市立醫院', '聯合診所', '仁愛醫療中心', '康健診所', '長庚醫院'],
                    icon: 'fas fa-hospital'
                },
                '教育': {
                    names: ['國立大學', '市立圖書館', '文化中心', '知識補習班', '國民小學'],
                    icon: 'fas fa-school'
                },
                '其他': {
                    names: ['市民活動中心', '區公所', '圖書館', '藝文表演廳', '公園綠地'],
                    icon: 'fas fa-star'
                }
            };

            const { names, icon } = poiData[category] || poiData['其他'];

            const results = [];
            for (let i = 0; i < count; i++) {
                const name = names[Math.floor(Math.random() * names.length)];
                const number = Math.floor(Math.random() * 100) + 1;
                const addr = ['中山區', '大安區', '信義區', '松山區'];
                const district = addr[Math.floor(Math.random() * addr.length)];
                const address = district + ' ' + (number + '號');

                results.push({ name, icon, address });
            }
            return results;
        }
    </script>
</body>
</html>
