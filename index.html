<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>繁體中文經緯度產生器 (僅保留至「號」)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-5">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-center mb-6">繁體中文經緯度產生器</h1>
        <p class="text-gray-600 mb-6 text-center">將Excel檔案中的中文地址處理後轉換為經緯度座標</p>
        
        <div class="flex flex-wrap justify-center gap-4 mb-6">
            <div>
                <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-300">
                    選擇Excel檔案
                </button>
            </div>
            <button id="generateBtn" onclick="generateCoordinates()" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-green-300" disabled>
                產生經緯度
            </button>
            <button id="downloadBtn" onclick="downloadResults()" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-purple-300 hidden">
                下載結果
            </button>
        </div>
        
        <div id="loadingIndicator" class="hidden">
            <div class="flex items-center justify-center space-x-2 mb-4">
                <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse"></div>
                <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse delay-75"></div>
                <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse delay-150"></div>
            </div>
            <p class="text-center text-gray-600" id="progressText">處理中，請稍候...</p>
        </div>
        
        <div id="fileInfo" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold mb-2">檔案資訊：</h3>
            <p id="fileName" class="text-gray-700"></p>
            <p id="addressCount" class="text-gray-700"></p>
        </div>
        
        <div id="resultsContainer" class="hidden">
            <h3 class="font-semibold mb-4">查詢結果：</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr>
                            <th class="px-4 py-2 border-b bg-gray-50 text-left">原始地址</th>
                            <th class="px-4 py-2 border-b bg-gray-50 text-left">處理後地址</th>
                            <th class="px-4 py-2 border-b bg-gray-50 text-left">經緯度</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '874dd31a406847e6b108ba60cdc5b566';
        let addresses = [];
        let results = [];

        // 中文數字轉換為阿拉伯數字的映射
        const chineseToArabic = {
            '零': '0', '一': '1', '二': '2', '三': '3', '四': '4', '五': '5',
            '六': '6', '七': '7', '八': '8', '九': '9', '十': '10', 
            '壹': '1', '貳': '2', '參': '3', '肆': '4', '伍': '5',
            '陸': '6', '柒': '7', '捌': '8', '玖': '9', '拾': '10'
        };

        function convertChineseNumbersToArabic(text) {
            // 檢查是否包含中文數字
            let result = text;
            for (const [chinese, arabic] of Object.entries(chineseToArabic)) {
                result = result.replace(new RegExp(chinese, 'g'), arabic);
            }
            
            // 處理特殊情況如"十一"變為"11"等
            result = result.replace(/(\d+)十(\d+)/g, (match, p1, p2) => `${p1}${p2}`);
            result = result.replace(/十(\d+)/g, (match, p1) => `1${p1}`);
            result = result.replace(/(\d+)十/g, (match, p1) => `${p1}0`);
            
            return result;
        }

        function processAddress(address) {
            if (!address) return '';
            
            // 轉換中文數字為阿拉伯數字
            let processedAddress = convertChineseNumbersToArabic(address);
            
            // 只保留到「號」的部分
            const numberPattern = /(.*?[0-9]+號)/;
            const match = processedAddress.match(numberPattern);
            
            if (match && match[1]) {
                return match[1];
            }
            
            // 如果找不到「號」，則返回原始處理地址
            return processedAddress;
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileNameElem = document.getElementById('fileName');
            fileNameElem.textContent = `檔案名稱: ${file.name}`;
            
            try {
                const data = await readExcelFile(file);
                addresses = data.filter(addr => addr && addr.trim() !== '');
                
                const addressCountElem = document.getElementById('addressCount');
                addressCountElem.textContent = `地址數量: ${addresses.length}`;
                
                document.getElementById('fileInfo').classList.remove('hidden');
                document.getElementById('generateBtn').disabled = false;
                
                // 清除之前的結果
                document.getElementById('resultsTable').innerHTML = '';
                document.getElementById('resultsContainer').classList.add('hidden');
                document.getElementById('downloadBtn').classList.add('hidden');
            } catch (error) {
                alert('讀取Excel檔案時發生錯誤: ' + error.message);
                console.error('Error reading Excel file:', error);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // 只獲取第一列的地址數據
                        const addresses = [];
                        let i = 1; // 從第2行開始（假設第1行是標題）
                        
                        while (true) {
                            const cell = worksheet['A' + i];
                            if (!cell) break;
                            addresses.push(cell.v);
                            i++;
                        }
                        
                        resolve(addresses);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function(error) {
                    reject(error);
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        async function generateCoordinates() {
            if (addresses.length === 0) {
                alert('請先選擇Excel檔案');
                return;
            }
            
            // 顯示載入指示器
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('generateBtn').disabled = true;
            results = [];
            
            try {
                // 循環處理每個地址
                for (let i = 0; i < addresses.length; i++) {
                    const originalAddress = addresses[i];
                    const processedAddress = processAddress(originalAddress);
                    
                    // 更新進度
                    document.getElementById('progressText').textContent = 
                        `處理中 (${i+1}/${addresses.length}): ${processedAddress}`;
                    
                    try {
                        // 調用OpenCage API獲取經緯度
                        const coordinates = await getCoordinates(processedAddress);
                        results.push({
                            originalAddress,
                            processedAddress,
                            coordinates
                        });
                    } catch (error) {
                        console.error(`Error processing address ${processedAddress}:`, error);
                        results.push({
                            originalAddress,
                            processedAddress,
                            coordinates: '無法獲取經緯度'
                        });
                    }
                    
                    // 等待一小段時間防止API速率限制
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                // 顯示結果
                displayResults();
                
                // 啟用下載按鈕
                document.getElementById('downloadBtn').classList.remove('hidden');
            } catch (error) {
                alert('處理地址時發生錯誤: ' + error.message);
                console.error('Error processing addresses:', error);
            } finally {
                // 隱藏載入指示器
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('generateBtn').disabled = false;
            }
        }

        async function getCoordinates(address) {
            try {
                const encodedAddress = encodeURIComponent(address);
                const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodedAddress}&key=${API_KEY}&language=zh-Hant&limit=1`);
                
                if (!response.ok) {
                    throw new Error(`API返回錯誤: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    return `${result.geometry.lat}, ${result.geometry.lng}`;
                } else {
                    return '未找到';
                }
            } catch (error) {
                console.error('Geocoding API error:', error);
                return '查詢錯誤';
            }
        }

        function displayResults() {
            const resultsTable = document.getElementById('resultsTable');
            resultsTable.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                
                const originalCell = document.createElement('td');
                originalCell.className = 'px-4 py-2 border-b';
                originalCell.textContent = result.originalAddress;
                
                const processedCell = document.createElement('td');
                processedCell.className = 'px-4 py-2 border-b';
                processedCell.textContent = result.processedAddress;
                
                const coordinatesCell = document.createElement('td');
                coordinatesCell.className = 'px-4 py-2 border-b';
                coordinatesCell.textContent = result.coordinates;
                
                row.appendChild(originalCell);
                row.appendChild(processedCell);
                row.appendChild(coordinatesCell);
                
                resultsTable.appendChild(row);
            });
            
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        function downloadResults() {
            if (results.length === 0) {
                alert('沒有可下載的結果');
                return;
            }
            
            let csvContent = '原始地址,處理後地址,經緯度\n';
            
            results.forEach(result => {
                const originalAddress = `"${result.originalAddress.replace(/"/g, '""')}"`;
                const processedAddress = `"${result.processedAddress.replace(/"/g, '""')}"`;
                const coordinates = `"${result.coordinates.replace(/"/g, '""')}"`;
                
                csvContent += `${originalAddress},${processedAddress},${coordinates}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', '地址經緯度結果.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
