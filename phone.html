<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣地址距離計算器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-md">
        <!-- 標題 -->
        <div class="bg-blue-600 text-white rounded-t-lg p-4 shadow-md">
            <h1 class="text-2xl font-bold text-center">台灣地址距離計算器 KC暴力計算</h1>
        </div>

        <!-- 主要內容區 -->
        <div class="bg-white rounded-b-lg shadow-md p-4 mb-4">
            <!-- 使用者當前位置 -->
            <div class="mb-4">
                <h2 class="font-bold text-lg text-blue-700 mb-2">當前位置</h2>
                <div class="bg-gray-100 p-3 rounded-lg">
                    <p id="userLocation" class="text-gray-700">獲取中...</p>
                </div>
            </div>

            <!-- 地址輸入 -->
            <div class="mb-4">
                <h2 class="font-bold text-lg text-blue-700 mb-2">輸入台灣地址</h2>
                <div class="flex">
                    <input type="text" id="addressInput" placeholder="例：台北市信義區市府路一號" 
                           class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="generateMapBtn" class="bg-blue-500 text-white px-3 py-2 rounded-r-lg hover:bg-blue-600 transition">
                        <i class="fas fa-map-marker-alt mr-1"></i> 生成地圖
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">中文數字會自動轉換為阿拉伯數字</p>
            </div>

            <!-- 地圖連結 -->
            <div class="mb-4">
                <h2 class="font-bold text-lg text-blue-700 mb-2">地圖連結</h2>
                <div class="bg-gray-100 p-3 rounded-lg">
                    <p id="mapLinkContainer" class="text-gray-700 break-all">尚未生成連結</p>
                </div>
            </div>

            <!-- 目標位置經緯度 -->
            <div class="mb-4">
                <h2 class="font-bold text-lg text-blue-700 mb-2">目標位置經緯度</h2>
                <div class="bg-gray-100 p-3 rounded-lg">
                    <p id="targetLocation" class="text-gray-700">尚未獲取</p>
                </div>
            </div>

            <!-- 距離計算按鈕 -->
            <button id="calculateDistanceBtn" class="w-full bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition font-bold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-calculator mr-2"></i> 計算距離
            </button>
        </div>

        <!-- 結果顯示區 -->
        <div id="resultContainer" class="bg-white rounded-lg shadow-md p-4 hidden">
            <h2 class="font-bold text-xl text-center text-green-700 mb-3">計算結果</h2>
            
            <div class="mb-3">
                <h3 class="font-bold text-blue-600"><i class="fas fa-street-view mr-1"></i> 您的位置：</h3>
                <p id="resultUserLocation" class="pl-6 py-1"></p>
            </div>
            
            <div class="mb-3">
                <h3 class="font-bold text-blue-600"><i class="fas fa-map-pin mr-1"></i> 目標位置：</h3>
                <p id="resultTargetLocation" class="pl-6 py-1"></p>
            </div>
            
            <div class="bg-blue-100 p-3 rounded-lg text-center">
                <h3 class="font-bold text-blue-800"><i class="fas fa-route mr-1"></i> 直線距離：</h3>
                <p id="distanceResult" class="text-2xl font-bold text-blue-800"></p>
            </div>
        </div>
    </div>

    <script>
        // 中文數字轉阿拉伯數字
        function convertChineseNumbers(text) {
            const chineseNums = {
                '零': '0', '一': '1', '二': '2', '三': '3', '四': '4',
                '五': '5', '六': '6', '七': '7', '八': '8', '九': '9',
                '十': '10'
            };
            
            // 處理一般的中文數字替換
            for (const [chinese, arabic] of Object.entries(chineseNums)) {
                text = text.replace(new RegExp(chinese, 'g'), arabic);
            }
            
            return text;
        }

        // 取得使用者當前位置
        let userLat = null;
        let userLng = null;
        
        function getUserLocation() {
            const userLocationElement = document.getElementById('userLocation');
            
            if (navigator.geolocation) {
                userLocationElement.textContent = "正在獲取位置...";
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;
                        userLocationElement.textContent = `經度: ${userLng}, 緯度: ${userLat}`;
                    },
                    function(error) {
                        let errorMsg = "無法獲取位置";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = "您已拒絕位置請求權限";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = "位置資訊不可用";
                                break;
                            case error.TIMEOUT:
                                errorMsg = "位置請求超時";
                                break;
                        }
                        userLocationElement.textContent = errorMsg;
                    }
                );
            } else {
                userLocationElement.textContent = "您的瀏覽器不支援地理位置功能";
            }
        }

        // 生成地圖連結
        let targetLat = null;
        let targetLng = null;

        function generateMapLink() {
            const addressInput = document.getElementById('addressInput');
            const mapLinkContainer = document.getElementById('mapLinkContainer');
            const targetLocationElement = document.getElementById('targetLocation');
            const calculateBtn = document.getElementById('calculateDistanceBtn');
            
            // 清空先前的目標位置
            targetLat = null;
            targetLng = null;
            targetLocationElement.textContent = "正在獲取...";
            calculateBtn.disabled = true;
            
            // 轉換地址中的中文數字
            let address = addressInput.value.trim();
            if (!address) {
                mapLinkContainer.textContent = "請輸入地址";
                targetLocationElement.textContent = "尚未獲取";
                return;
            }
            
            address = convertChineseNumbers(address);
            addressInput.value = address; // 更新輸入框顯示轉換後的地址
            
            // 生成Google地圖連結
            const mapUrl = `https://www.google.com/maps/place/${encodeURIComponent(address)}`;
            
            // 創建地圖連結並顯示
            mapLinkContainer.innerHTML = `<a href="${mapUrl}" target="_blank" id="mapLink" class="text-blue-600 underline break-all">${mapUrl}</a>`;
            
            // 模擬自動獲取經緯度
            // 由於瀏覽器安全限制，我們無法直接獲取重定向後的URL
            // 這裡提供一個輸入框讓用戶粘貼重定向後的URL
            
            targetLocationElement.innerHTML = `
                <div class="mb-2">請點擊上方地圖連結，複製瀏覽器地址列的網址並貼上：</div>
                <input type="text" id="redirectUrlInput" placeholder="貼上地圖重定向後的URL" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="extractCoordinatesBtn" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">提取座標</button>
            `;
            
            // 為提取座標按鈕添加事件
            document.getElementById('extractCoordinatesBtn').addEventListener('click', extractCoordinates);
        }

        // 從重定向URL中提取座標
        function extractCoordinates() {
            const redirectUrl = document.getElementById('redirectUrlInput').value.trim();
            const targetLocationElement = document.getElementById('targetLocation');
            const calculateBtn = document.getElementById('calculateDistanceBtn');
            
            if (!redirectUrl) {
                targetLocationElement.innerHTML = `
                    <div class="text-red-500">請輸入重定向後的URL</div>
                    <input type="text" id="redirectUrlInput" placeholder="貼上地圖重定向後的URL" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="extractCoordinatesBtn" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">提取座標</button>
                `;
                document.getElementById('extractCoordinatesBtn').addEventListener('click', extractCoordinates);
                return;
            }
            
            // 使用正則表達式從URL中提取座標
            const coordsRegex = /@([-\d.]+),([-\d.]+)/;
            const match = redirectUrl.match(coordsRegex);
            
            if (match && match.length >= 3) {
                targetLat = parseFloat(match[1]);
                targetLng = parseFloat(match[2]);
                
                targetLocationElement.textContent = `經度: ${targetLng}, 緯度: ${targetLat}`;
                calculateBtn.disabled = false;
            } else {
                targetLocationElement.innerHTML = `
                    <div class="text-red-500">無法從URL中提取座標，請確保URL格式正確</div>
                    <div class="text-xs mt-1">URL應包含形如 @25.0624007,121.3655983 的座標</div>
                    <input type="text" id="redirectUrlInput" placeholder="貼上地圖重定向後的URL" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2">
                    <button id="extractCoordinatesBtn" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">提取座標</button>
                `;
                document.getElementById('extractCoordinatesBtn').addEventListener('click', extractCoordinates);
            }
        }

        // 計算兩點之間的距離（使用Haversine公式）
        function calculateDistance() {
            if (userLat === null || userLng === null || targetLat === null || targetLng === null) {
                alert("請確保已獲取您的位置和目標位置");
                return;
            }
            
            const R = 6371000; // 地球半徑（米）
            const φ1 = userLat * Math.PI / 180; // φ, λ 均為弧度
            const φ2 = targetLat * Math.PI / 180;
            const Δφ = (targetLat - userLat) * Math.PI / 180;
            const Δλ = (targetLng - userLng) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                     Math.cos(φ1) * Math.cos(φ2) *
                     Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = Math.floor(R * c); // 以米為單位，去除小數點
            
            // 顯示結果
            document.getElementById('resultUserLocation').textContent = `經度: ${userLng}, 緯度: ${userLat}`;
            document.getElementById('resultTargetLocation').textContent = `經度: ${targetLng}, 緯度: ${targetLat}`;
            document.getElementById('distanceResult').textContent = `${distance} 公尺`;
            
            // 顯示結果容器
            document.getElementById('resultContainer').classList.remove('hidden');
        }

        // 頁面加載完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 獲取用戶位置
            getUserLocation();
            
            // 綁定按鈕事件
            document.getElementById('generateMapBtn').addEventListener('click', generateMapLink);
            document.getElementById('calculateDistanceBtn').addEventListener('click', calculateDistance);
            
            // 監聽地址輸入的變化，實時將中文數字轉換為阿拉伯數字
            document.getElementById('addressInput').addEventListener('input', function(e) {
                const cursorPosition = this.selectionStart;
                const originalValue = this.value;
                const convertedValue = convertChineseNumbers(originalValue);
                
                if (originalValue !== convertedValue) {
                    this.value = convertedValue;
                    // 嘗試維持光標位置
                    this.setSelectionRange(cursorPosition, cursorPosition);
                }
            });
        });
    </script>
</body>
</html>
