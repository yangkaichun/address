<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地址經緯度轉換工具</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold text-center mb-6">地址經緯度轉換工具</h1>
        
        <div id="location-info" class="mb-4 text-center text-sm text-gray-600">
            正在獲取您的位置...
        </div>
        
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-6">
            <div class="flex items-center">
                <label for="fileInput" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded cursor-pointer">
                    選擇Excel檔案
                </label>
                <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden" />
                <span id="fileName" class="ml-2 text-gray-600">未選擇檔案</span>
            </div>
            
            <button id="processButton" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded" disabled>
                產生經緯度
            </button>
            
            <button id="downloadButton" class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded" disabled>
                下載結果
            </button>
        </div>
        
        <div id="progress" class="hidden mb-4">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-center mt-2 text-sm text-gray-600">處理中: 0%</p>
        </div>
        
        <div id="resultContainer" class="hidden mt-6 overflow-x-auto">
            <h2 class="text-xl font-semibold mb-3">處理結果</h2>
            <table id="resultTable" class="w-full border">
                <thead>
                    <tr>
                        <th>原始地址</th>
                        <th>處理後地址</th>
                        <th>經度</th>
                        <th>緯度</th>
                        <th>地圖</th>
                        <th>Google座標</th>
                        <th>距離(公尺)</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // 全局變量
        let userLocation = null;
        let excelData = null;
        let processedData = [];
        const API_KEY = '874dd31a406847e6b108ba60cdc5b566'; // OpenCage API Key
        
        // 初始化：獲取用戶位置
        document.addEventListener('DOMContentLoaded', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        document.getElementById('location-info').innerHTML = 
                            `您的當前位置: 緯度 ${userLocation.lat.toFixed(6)}, 經度 ${userLocation.lng.toFixed(6)}`;
                    },
                    function(error) {
                        document.getElementById('location-info').innerHTML = 
                            `無法獲取您的位置: ${error.message}`;
                    }
                );
            } else {
                document.getElementById('location-info').innerHTML = 
                    '您的瀏覽器不支持地理位置功能';
            }
        });
        
        // 文件上傳處理
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('processButton').disabled = false;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    console.log('已讀取Excel檔案', excelData.length, '行');
                } catch (error) {
                    console.error('Excel檔案讀取錯誤:', error);
                    alert('Excel檔案讀取錯誤: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        // 處理按鈕點擊事件
        document.getElementById('processButton').addEventListener('click', async function() {
            if (!excelData || excelData.length <= 1) {
                alert('請上傳有效的Excel檔案');
                return;
            }
            
            // 重置處理數據
            processedData = [];
            document.getElementById('processButton').disabled = true;
            document.getElementById('downloadButton').disabled = true;
            document.getElementById('resultBody').innerHTML = '';
            
            // 顯示進度條
            document.getElementById('progress').classList.remove('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '處理中: 0%';
            
            // 獲取地址數據（跳過標題行）
            const addresses = excelData.slice(1).map(row => row[0]).filter(address => address);
            
            try {
                await processAddresses(addresses);
                
                // 顯示結果
                document.getElementById('resultContainer').classList.remove('hidden');
                document.getElementById('downloadButton').disabled = false;
            } catch (error) {
                console.error('處理錯誤:', error);
                alert('處理過程中發生錯誤: ' + error.message);
            } finally {
                document.getElementById('processButton').disabled = false;
            }
        });
        
        // 下載按鈕點擊事件
        document.getElementById('downloadButton').addEventListener('click', function() {
            if (processedData.length === 0) {
                alert('沒有可下載的數據');
                return;
            }
            
            try {
                // 創建工作表
                const ws = XLSX.utils.json_to_sheet(processedData.map(item => ({
                    '原始地址': item.originalAddress,
                    '處理後地址': item.processedAddress,
                    '經度': item.longitude,
                    '緯度': item.latitude,
                    '地圖連結': item.mapUrl,
                    'Google座標': item.googleCoords,
                    '距離(公尺)': item.distance
                })));
                
                // 創建工作簿
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '地址經緯度');
                
                // 下載
                XLSX.writeFile(wb, '地址經緯度結果.xlsx');
            } catch (error) {
                console.error('下載錯誤:', error);
                alert('生成Excel檔案時發生錯誤: ' + error.message);
            }
        });
        
        // 處理地址列表
        async function processAddresses(addresses) {
            let count = 0;
            
            for (const originalAddress of addresses) {
                try {
                    // 處理地址
                    const processedAddress = processAddress(originalAddress);
                    
                    // 獲取經緯度
                    const coords = await getCoordinates(processedAddress);
                    
                    // 創建Google地圖連結
                    const mapUrl = `https://www.google.com/maps/place/${encodeURIComponent(originalAddress)}`;
                    
                    // 獲取Google的重定向座標
                    const googleCoords = await getGoogleRedirectCoords(mapUrl);
                    
                    // 計算距離
                    let distance = '無法計算';
                    if (userLocation && googleCoords) {
                        const coordParts = googleCoords.split(',');
                        if (coordParts.length >= 2) {
                            const lat = parseFloat(coordParts[0]);
                            const lng = parseFloat(coordParts[1]);
                            distance = Math.round(calculateDistance(userLocation.lat, userLocation.lng, lat, lng));
                        }
                    }
                    
                    // 保存結果
                    const resultItem = {
                        originalAddress,
                        processedAddress,
                        latitude: coords ? coords.lat : '未找到',
                        longitude: coords ? coords.lng : '未找到',
                        mapUrl,
                        googleCoords: googleCoords || '未找到',
                        distance: typeof distance === 'number' ? distance : distance
                    };
                    
                    processedData.push(resultItem);
                    addResultRow(resultItem);
                } catch (error) {
                    console.error(`處理地址 "${originalAddress}" 時發生錯誤:`, error);
                    
                    // 添加錯誤結果
                    const resultItem = {
                        originalAddress,
                        processedAddress: processAddress(originalAddress),
                        latitude: '錯誤',
                        longitude: '錯誤',
                        mapUrl: `https://www.google.com/maps/place/${encodeURIComponent(originalAddress)}`,
                        googleCoords: '錯誤',
                        distance: '錯誤'
                    };
                    
                    processedData.push(resultItem);
                    addResultRow(resultItem);
                }
                
                // 更新進度
                count++;
                const progress = Math.round((count / addresses.length) * 100);
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `處理中: ${progress}%`;
                
                // 延遲以避免API請求過快
                if (count < addresses.length) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
        }
        
        // 將中文數字轉換為阿拉伯數字，並只保留到「號」
        function processAddress(address) {
            if (!address) return '';
            
            // 中文數字對照表
            const chineseNumbers = {
                '零': '0', '一': '1', '二': '2', '三': '3', '四': '4',
                '五': '5', '六': '6', '七': '7', '八': '8', '九': '9',
                '壹': '1', '貳': '2', '參': '3', '肆': '4', '伍': '5',
                '陸': '6', '柒': '7', '捌': '8', '玖': '9', '拾': '10',
                '十': '10', '百': '100', '佰': '100', '千': '1000', '仟': '1000',
                '萬': '10000', '億': '100000000'
            };
            
            // 轉換函數
            function convertChineseNumber(text) {
                let result = '';
                let tempNum = 0;
                let tempDigit = 1;
                let isNumber = false;
                
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (chineseNumbers[char] !== undefined) {
                        isNumber = true;
                        const num = parseInt(chineseNumbers[char]);
                        if (num >= 10) {
                            if (tempNum === 0) tempNum = 1;
                            if (num === 10) {
                                tempNum *= 10;
                            } else {
                                tempNum *= num;
                            }
                            result += tempNum.toString();
                            tempNum = 0;
                            tempDigit = 1;
                        } else {
                            if (i + 1 < text.length && parseInt(chineseNumbers[text[i + 1]] || 0) >= 10) {
                                tempNum += num;
                            } else {
                                tempNum += num * tempDigit;
                                tempDigit *= 10;
                            }
                        }
                    } else {
                        if (isNumber) {
                            if (tempNum > 0) {
                                result += tempNum.toString();
                            }
                            tempNum = 0;
                            tempDigit = 1;
                            isNumber = false;
                        }
                        result += char;
                    }
                }
                
                if (tempNum > 0) {
                    result += tempNum.toString();
                }
                
                return result;
            }
            
            // 轉換中文數字
            let processedAddr = convertChineseNumber(address);
            
            // 截取到「號」
            const index = processedAddr.indexOf('號');
            if (index !== -1) {
                processedAddr = processedAddr.substring(0, index + 1);
            }
            
            return processedAddr;
        }
        
        // 從OpenCage API獲取經緯度
        async function getCoordinates(address) {
            try {
                const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(address)}&key=${API_KEY}&language=zh-TW&limit=1`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    return {
                        lat: data.results[0].geometry.lat,
                        lng: data.results[0].geometry.lng
                    };
                }
                return null;
            } catch (error) {
                console.error('獲取座標錯誤:', error);
                return null;
            }
        }
        
        // 獲取Google地圖重定向後的座標
        async function getGoogleRedirectCoords(url) {
            try {
                // 模擬訪問Google地圖URL並獲取重定向URL
                const response = await fetch(url, { method: 'HEAD', redirect: 'follow' });
                const redirectUrl = response.url;
                
                // 提取@後面到斜線之間的座標
                const match = redirectUrl.match(/@([^\/]+)/);
                if (match && match[1]) {
                    // 只保留數字、逗號和小數點
                    return match[1].replace(/[^0-9,\.]/g, '');
                }
                return null;
            } catch (error) {
                console.error('獲取Google重定向座標錯誤:', error);
                return null;
            }
        }
        
        // 計算兩點之間的距離（米）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // 地球半徑（米）
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // 距離（米）
        }
        
        // 角度轉弧度
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
        
        // 添加結果行到表格
        function addResultRow(item) {
            const tbody = document.getElementById('resultBody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${item.originalAddress}</td>
                <td>${item.processedAddress}</td>
                <td>${typeof item.longitude === 'number' ? item.longitude.toFixed(6) : item.longitude}</td>
                <td>${typeof item.latitude === 'number' ? item.latitude.toFixed(6) : item.latitude}</td>
                <td><a href="${item.mapUrl}" target="_blank" class="text-blue-500 hover:underline">地圖</a></td>
                <td>${item.googleCoords}</td>
                <td>${item.distance}</td>
            `;
            
            tbody.appendChild(row);
        }
    </script>
</body>
</html>
