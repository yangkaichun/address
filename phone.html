<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distance Calculator</title>
    <style>
        /* Basic CSS for layout - You'll need to enhance this */
        body { font-family: sans-serif; }
        .container { display: flex; flex-direction: column; align-items: center; }
        input[type="text"] { padding: 8px; margin: 5px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #locationInfo, #distanceInfo { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Distance Calculator</h2>

        <div id="currentLocation">
            <p>Loading current location...</p>
        </div>

        <div>
            <label for="address">Taiwan Address:</label>
            <input type="text" id="address" name="address">
            <button onclick="generateMapLink()">Generate Map Link</button>
        </div>

        <div>
            <label for="coordinates">Google Coordinates:</label>
            <input type="text" id="coordinates" name="coordinates" readonly>
        </div>

        <button onclick="calculateDistance()">Calculate Distance</button>

        <div id="locationInfo">
            <p>1. Mobile Location (Latitude, Longitude): <span id="mobileCoords"></span></p>
            <p>2. Target Location (Latitude, Longitude): <span id="targetCoords"></span></p>
            <p>3. Distance: <span id="distance"></span> meters</p>
        </div>
    </div>

    <script>
        let currentLatitude;
        let currentLongitude;
        let targetLatitude;
        let targetLongitude;

        // 1. Get Current Location
        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                document.getElementById("currentLocation").innerHTML = "Geolocation is not supported by this browser.";
            }
        };

        function showPosition(position) {
            currentLatitude = position.coords.latitude;
            currentLongitude = position.coords.longitude;
            document.getElementById("currentLocation").innerHTML = `Current Location: Latitude ${currentLatitude.toFixed(6)}, Longitude ${currentLongitude.toFixed(6)}`;
            document.getElementById("mobileCoords").textContent = `${currentLatitude.toFixed(6)}, ${currentLongitude.toFixed(6)}`;
        }

        function showError(error) {
            let errorMsg;
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    errorMsg = "The request to get user location timed out.";
                    break;
                case error.UNKNOWN_ERROR:
                    errorMsg = "An unknown error occurred.";
                    break;
            }
            document.getElementById("currentLocation").innerHTML = errorMsg;
        }

        // 2. Convert Chinese Numerals (Basic Example - You'll need a more comprehensive solution)
        function convertChineseNumerals(address) {
            const mapping = {'一': '1', '二': '2', '三': '3', '四': '4', '五': '5', '六': '6', '七': '7', '八': '8', '九': '9', '十': '10'};
            let convertedAddress = address;
            for (const chinese in mapping) {
                convertedAddress = convertedAddress.replace(new RegExp(chinese, 'g'), mapping[chinese]);
            }
            // You might need to handle cases like 二十, 三十一, etc., for a full implementation.
            return convertedAddress;
        }

        // Attach an event listener to the address input for conversion
        document.getElementById('address').addEventListener('blur', function() {
            this.value = convertChineseNumerals(this.value);
        });

        // 3. Generate Google Maps Link
        function generateMapLink() {
            const address = document.getElementById("address").value;
            const encodedAddress = encodeURIComponent(address + ' Taiwan'); // Adding 'Taiwan' for better results
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
            // For demonstration, let's simulate the return and extraction
            const simulatedReturn = `https://www.google.com/maps/place/%E6%A1%83%E5%9C%92%E5%B8%82%E9%BE%9C%E5%B1%B1%E5%8D%80%E6%96%87%E9%9D%92%E8%B7%AF2%E6%AE%B513%E8%99%9F/@25.0478064,121.3608766,17z/data=!3m1!4b1!4m5!3m4!1s0x3442a7a979896b1f:0x9c2289199609196f!8m2!3d25.0478064!4d121.3630653?entry=tts`;
            extractCoordinates(simulatedReturn);
            // In a real application, you might open this link or use a service to get coordinates.
            console.log("Generated Map Link:", mapLink);
            // For now, we'll simulate the extraction from a sample link.
        }

        // 4. Extract Coordinates
        function extractCoordinates(url) {
            const atIndex = url.indexOf('@');
            if (atIndex !== -1) {
                const substring = url.substring(atIndex + 1);
                const commaIndex = substring.indexOf(',');
                const slashIndex = substring.indexOf('/');
                if (commaIndex !== -1 && slashIndex !== -1 && commaIndex < slashIndex) {
                    const coordsPart = substring.substring(0, slashIndex);
                    const parts = coordsPart.split(',');
                    if (parts.length === 2) {
                        targetLatitude = parseFloat(parts[0]);
                        targetLongitude = parseFloat(parts[1]);
                        document.getElementById("coordinates").value = `${targetLatitude.toFixed(6)}, ${targetLongitude.toFixed(6)}`;
                        document.getElementById("targetCoords").textContent = `${targetLatitude.toFixed(6)}, ${targetLongitude.toFixed(6)}`;
                    }
                }
            }
        }

        // 5. Calculate Distance (Haversine Formula)
        function calculateDistance() {
            if (currentLatitude === undefined || currentLongitude === undefined || targetLatitude === undefined || targetLongitude === undefined) {
                alert("Please make sure your current location is loaded and a target address has been processed.");
                return;
            }

            const R = 6371e3; // metres
            const φ1 = toRadians(currentLatitude);
            const φ2 = toRadians(targetLatitude);
            const Δφ = toRadians(targetLatitude - currentLatitude);
            const Δλ = toRadians(targetLongitude - currentLongitude);

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // in metres
            document.getElementById("distance").textContent = Math.floor(distance);
        }

        function toRadians(degrees) {
            return degrees * Math.PI / 180;
        }
    </script>
</body>
</html>
